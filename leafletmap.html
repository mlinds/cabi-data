<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>

    <script src="https://unpkg.com/vega@5.21.0/build/vega.js"></script>
    <script src="https://unpkg.com/regenerator-runtime@0.11.1/runtime.js"></script>
    <!-- <script src="https://unpkg.com/vega-lite@5.2.0/build/vega-lite.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-vega@0.8.6/dist/bundle.js" crossorigin=""></script>
    <style>
        #map {
            height: 1000px;
        }
    </style>

</head>


<body>
    <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
    <div id="map"></div>
    <script>
        var map = L.map('map').setView([38.87, -77], 10);
        var CyclOSM = L.tileLayer('https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png', {
            maxZoom: 20,
            attribution: '<a href="https://github.com/cyclosm/cyclosm-cartocss-style/releases" title="CyclOSM - Open Bicycle render">CyclOSM</a> | Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });
        var vegaspec = {
            "$schema": "https://vega.github.io/schema/vega/v5.json",
            "background": "white",
            "padding": 5,
            "width": 400,
            "height": 300,
            "style": "cell",
            "data": [
                { "name": "selector001_store" },
                {
                    "name": "source_1",
                    "url": "https://raw.githubusercontent.com/mlinds/cabi-data/main/data/stationLookup.csv",
                    "format": { "type": "csv", "delimiter": "," }
                },
                {
                    "name": "source_0",
                    "url": "https://raw.githubusercontent.com/mlinds/cabi-data/main/data/connections_csv.csv",
                    "format": { "type": "csv", "delimiter": "," },
                    "transform": [
                        {
                            "type": "lookup",
                            "from": "source_1",
                            "key": "short_name",
                            "fields": ["st"],
                            "values": ["name", "lat", "lon"]
                        },
                        {
                            "type": "lookup",
                            "from": "source_1",
                            "key": "short_name",
                            "fields": ["en"],
                            "values": ["name", "lat", "lon"],
                            "as": ["name2", "lat2", "lon2"]
                        },
                        {
                            "type": "filter",
                            "expr": "(vlSelectionTest(\"selector001_store\", datum))"
                        },
                        {
                            "type": "geojson",
                            "fields": ["lon", "lat"],
                            "signal": "layer_0_geojson_0"
                        },
                        {
                            "type": "geojson",
                            "fields": ["lon2", "lat2"],
                            "signal": "layer_0_geojson_1"
                        },
                        {
                            "type": "geopoint",
                            "projection": "projection",
                            "fields": ["lon", "lat"],
                            "as": ["layer_0_x", "layer_0_y"]
                        },
                        {
                            "type": "geopoint",
                            "projection": "projection",
                            "fields": ["lon2", "lat2"],
                            "as": ["layer_0_x2", "layer_0_y2"]
                        },
                        {
                            "type": "filter",
                            "expr": "isValid(datum[\"popularity\"]) && isFinite(+datum[\"popularity\"])"
                        }
                    ]
                },
                {
                    "name": "data_0",
                    "source": "source_1",
                    "transform": [
                        {
                            "type": "lookup",
                            "from": "source_1",
                            "key": "short_name",
                            "fields": ["short_name"],
                            "values": ["short_name"],
                            "as": ["st"]
                        },
                        {
                            "type": "geojson",
                            "fields": ["lon", "lat"],
                            "signal": "layer_1_geojson_0"
                        },
                        {
                            "type": "geopoint",
                            "projection": "projection",
                            "fields": ["lon", "lat"],
                            "as": ["layer_1_x", "layer_1_y"]
                        }
                    ]
                }
            ],
            "projections": [
                {
                    "name": "projection",
                    "size": { "signal": "[width, height]" },
                    "fit": {
                        "signal": "[layer_0_geojson_0, layer_0_geojson_1, layer_1_geojson_0]"
                    }
                }
            ],
            "signals": [
                {
                    "name": "unit",
                    "value": {},
                    "on": [
                        { "events": "mousemove", "update": "isTuple(group()) ? group() : unit" }
                    ]
                },
                {
                    "name": "selector001",
                    "update": "vlSelectionResolve(\"selector001_store\", \"union\")"
                },
                {
                    "name": "selector001_tuple",
                    "on": [
                        {
                            "events": [
                                {
                                    "source": "scope",
                                    "type": "mouseover",
                                    "markname": "layer_1_voronoi"
                                }
                            ],
                            "update": "datum && item().mark.marktype !== 'group' ? {unit: \"layer_1\", fields: selector001_tuple_fields, values: [(item().isVoronoi ? datum.datum : datum)[\"st\"]]} : null",
                            "force": true
                        },
                        { "events": [{ "source": "scope", "type": "dblclick" }], "update": "null" }
                    ]
                },
                {
                    "name": "selector001_tuple_fields",
                    "value": [{ "type": "E", "field": "st" }]
                },
                {
                    "name": "selector001_modify",
                    "on": [
                        {
                            "events": { "signal": "selector001_tuple" },
                            "update": "modify(\"selector001_store\", selector001_tuple, true)"
                        }
                    ]
                }
            ],
            "marks": [
                {
                    "name": "layer_0_marks",
                    "type": "rule",
                    "style": ["rule"],
                    "sort": { "field": ["datum[\"popularity\"]"], "order": ["ascending"] },
                    "interactive": false,
                    "from": { "data": "source_0" },
                    "encode": {
                        "update": {
                            "stroke": { "scale": "color", "field": "popularity" },
                            "strokeWidth": { "scale": "strokeWidth", "field": "popularity" },
                            "x": { "field": "layer_0_x" },
                            "x2": { "field": "layer_0_x2" },
                            "y": { "field": "layer_0_y" },
                            "y2": { "field": "layer_0_y2" }
                        }
                    }
                },
                {
                    "name": "layer_1_marks",
                    "type": "symbol",
                    "style": ["circle"],
                    "interactive": true,
                    "from": { "data": "data_0" },
                    "encode": {
                        "update": {
                            "opacity": { "value": 0.7 },
                            "fill": { "value": "#4c78a8" },
                            "tooltip": { "signal": "{\"name\": ''+datum[\"name\"]}" },
                            "x": { "field": "layer_1_x" },
                            "y": { "field": "layer_1_y" },
                            "shape": { "value": "circle" }
                        }
                    }
                },
                {
                    "name": "layer_1_voronoi",
                    "type": "path",
                    "interactive": true,
                    "from": { "data": "layer_1_marks" },
                    "encode": {
                        "update": {
                            "fill": { "value": "transparent" },
                            "strokeWidth": { "value": 0.35 },
                            "stroke": { "value": "transparent" },
                            "isVoronoi": { "value": true },
                            "tooltip": { "signal": "{\"name\": ''+datum.datum[\"name\"]}" }
                        }
                    },
                    "transform": [
                        {
                            "type": "voronoi",
                            "x": { "expr": "datum.datum.x || 0" },
                            "y": { "expr": "datum.datum.y || 0" },
                            "size": [{ "signal": "width" }, { "signal": "height" }]
                        }
                    ]
                }
            ],
            "scales": [
                {
                    "name": "color",
                    "type": "quantile",
                    "domain": { "data": "source_0", "field": "popularity" },
                    "range": { "scheme": "inferno" },
                    "interpolate": "hcl"
                },
                {
                    "name": "strokeWidth",
                    "type": "quantile",
                    "domain": { "data": "source_0", "field": "popularity" },
                    "range": [1, 4]
                }
            ],
            "legends": [
                {
                    "stroke": "color",
                    "labelOverlap": "greedy",
                    "symbolType": "stroke",
                    "title": "popularity",
                    "strokeWidth": "strokeWidth"
                }
            ]
        };
        var vegalayer = L.vega(vegaspec, {
            // Make sure the legend stays in place when moving (slower)
            delayRepaint: true,

        });
        map.addLayer(CyclOSM);
        vegalayer.addTo(map);

        window.VEGA_DEBUG = {
            vegaspec,
            view: vegalayer._view
        };
    </script>
</body>

</html>